## Context

Системный промпт загружается из Vertex AI Prompt Management при старте контейнера. Агент создаётся один раз в `lifespan` и хранится в `app.state`. Чтобы применить изменения промпта, требуется редеплой.

Telegram бот должен иметь возможность перезагрузить промпт по команде, чтобы оператор мог обновить поведение агента без редеплоя сервиса.

## Goals / Non-Goals

**Goals:**
- Эндпоинт для перезагрузки промпта из Vertex AI
- Атомарное обновление агента и runner без прерывания обработки запросов
- Возврат статуса операции (успех/ошибка)

**Non-Goals:**
- Авторизация эндпоинта (Cloud Run IAM или отдельная авторизация — вне скоупа)
- Автоматическая периодическая перезагрузка
- Версионирование промптов

## Decisions

### 1. Хранение агента в mutable state

**Решение**: Хранить `agent` и `runner` в `app.state` и заменять при reload.

**Альтернатива**: Использовать глобальные переменные — менее чисто, сложнее тестировать.

**Обоснование**: `app.state` — стандартный паттерн FastAPI для mutable state.

### 2. Пересоздание Runner при reload

**Решение**: При reload пересоздавать Agent и Runner целиком.

**Альтернатива**: Пытаться обновить instruction в существующем агенте — ADK Agent не поддерживает динамическое обновление instruction.

**Обоснование**: ADK Agent immutable после создания, нужен новый экземпляр.

### 3. Session service сохраняется

**Решение**: При reload сохранять существующий `session_service`, только заменять agent/runner.

**Обоснование**: Сессии пользователей не должны теряться при обновлении промпта.

## Risks / Trade-offs

**[Race condition при reload]** → Использовать asyncio.Lock для сериализации reload операций. Текущие запросы используют старый runner до завершения.

**[Потеря промпта при ошибке reload]** → При ошибке загрузки нового промпта сохранять текущий агент, возвращать ошибку.

**[Несанкционированный reload]** → Эндпоинт доступен только через Cloud Run IAM. Дополнительная авторизация вне скоупа.
